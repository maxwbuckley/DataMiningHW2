---
title: 'Data Mining Homework 2: Premier League'
author: "Max Buckley"
date: "22/03/2016"
output: pdf_document
---

In this assignment I aim to explore throughly the provided dataset of Premier League soccer matches. From the brief the objective is:

>Your task is to analyse Premier League match data provided since 2010 up to and including last weekend (6 March 2016). You should attempt to uncover interesting and potentially useful patterns and rules which might be used to determine the outcome of the remaining matches in the 2016 league.

I will break my analysis into its logical steps so that I start with data cleaning and preperation, progress to data exploration, and then lastly attempt data modelling and prediction. I will include all my code in the interests of reproducable research.

An interesting thing to note is I have absolutely no interest in soccer I may be unaware of or ask naive questions of the data vis-a-vis the soccer afficianados in the class.

#Data Cleaning

```{r}
# Dependancies.
library("plyr")

# Clear R environment.
rm(list=ls())
# Set working directory .
setwd("~/UCD/DataMining/HW2/")

output_dir <- "CleanedData"
input_dir <- "InputData"

input_csv_files <- dir(input_dir)

# List to store all the data frames.
df_list <- list()
for(i in 1:length(input_csv_files)){
  file <- input_csv_files[i]
  df <- read.csv(paste0(input_dir, "/", file),
                 stringsAsFactors=FALSE)
  # Store a season indicator.
  df$Season <- gsub(".csv", "", file)
  df_list[[i]] <- df
}

# Combine all the data frames into one.
cleaned_data <- rbind.fill(df_list[1:i])
# Format date as proper R date object.
cleaned_data$Date <- as.Date(cleaned_data$Date, "%d/%m/%y")
# Factor desired character columns.
cleaned_data$FTR <- as.factor(cleaned_data$FTR)
cleaned_data$HTR <- as.factor(cleaned_data$HTR)
cleaned_data$HomeTeam <- as.factor(cleaned_data$HomeTeam)
cleaned_data$AwayTeam <- as.factor(cleaned_data$AwayTeam)
cleaned_data$Referee <- as.factor(cleaned_data$Referee)
cleaned_data$Season <- as.factor(cleaned_data$Season)

# Remove Division as it is a constant. It adds no info.
cleaned_data$Div <- NULL

#Calculate points
HomePoints<-rep(1, nrow(cleaned_data))
HomePoints[cleaned_data$FTR=="H"] <- 3
HomePoints[cleaned_data$FTR=="A"] <- 0
cleaned_data$HomePoints <- HomePoints
AwayPoints<-rep(1,nrow(cleaned_data))
AwayPoints[cleaned_data$FTR=="H"] <- 0
AwayPoints[cleaned_data$FTR=="A"] <- 3
cleaned_data$AwayPoints <-AwayPoints
cleaned_data$TotalGoals <-cleaned_data$FTHG + cleaned_data$FTAG


# Save as output to use later. Use .Rda format to preserve R
# type information in addition to data values.
save(cleaned_data, file = paste0(output_dir, "/",
                                 "cleaned_data.Rda"))
```
With some of my data preprocessing I now had a better idea of what my data source looks like and how it is strucutred.

Given the dataset is currently in wide form and quite difficult to work with I decided to switch it to long form. So rather than having the winner and loser in one row I would have one row for each side and I could then more easily aggregate it.

```{r message=FALSE, warning=FALSE}
# Libraries.
# Best plotting library ever
library("ggplot2")
# For data munging
library("reshape")
# More data munginf
library("reshape2")
# Same
library("plyr")
# Recursive Partitioning decision trees
library("rpart")
# The party package provides nonparametric regression trees
# for nominal, ordinal, numeric, censored, and multivariate
# responses.
library("party")

options(stringsAsFactors=FALSE)

# Clear R environment.
rm(list=ls())

#This will be used to avoid some division by zero errors later.
ratio_offset<-1e-6

# Set working directory .
setwd("~/UCD/DataMining/HW2/")
# This creates an object called cleaned_data in our environment.
load("CleanedData/cleaned_data.Rda")

# Gets our long form dataset. This function doesn't maintain all the columns.
get_long_data <- function(){
  # Take a subset of our data
  # Team names, results, refs and dates/seasons
  subset <- cleaned_data[,c(1:6, 10, 71, 75, 76, 77)]
  # Convet dataset to long form from wide form.
  sub_data <- melt(subset, id=c("Date", "FTHG", "FTAG", 
                                "FTR", "Referee", "Season", 
                                "HomePoints", "AwayPoints", 
                                "TotalGoals"))
  sub_data <- rename(sub_data, c("value" = "TeamName"))
  sub_data <- rename(sub_data, c("variable" = "HomeOrAway"))
  
  # Calculate the respective points for each team.
  sub_data$Points <- 0
  sub_data$Points[sub_data$HomeOrAway=="AwayTeam"] <-
    sub_data$AwayPoints[sub_data$HomeOrAway=="AwayTeam"]
  sub_data$Points[sub_data$HomeOrAway=="HomeTeam"] <-
    sub_data$HomePoints[sub_data$HomeOrAway=="HomeTeam"]
  
  # Create a factor as it can be easier for prediction.
  sub_data$Result<-as.factor(sub_data$Points)
  levels(sub_data$Result)<-c("L","D","W")
  
  sub_data$Goals <-0
  sub_data$Goals[sub_data$HomeOrAway=="AwayTeam"] <-
    sub_data$FTAG[sub_data$HomeOrAway=="AwayTeam"]
  sub_data$Goals[sub_data$HomeOrAway=="HomeTeam"] <-
    sub_data$FTHG[sub_data$HomeOrAway=="HomeTeam"]
  
  # Opponent
  opposition <-cbind.data.frame(rep(cleaned_data$AwayTeam, 2),
                                rep(cleaned_data$HomeTeam, 2))
  vec<-vector()
  for(i in 1:nrow(opposition)){
    if(sub_data$TeamName[i]==opposition[i, 1]){
     vec[i] <- as.character(opposition[i, 2])
    }
    else{
      vec[i] <- as.character(opposition[i, 1])
    }
  }
  sub_data$Opponent <-as.factor(vec)
  
  # Introduce a calculated metric. goal ratio. Which tells us
  # what proportion of the goals in that match that team scored.
  # To prevent division by zero NaNs. The round later removes this.
  sub_data$GoalRatio<-round((sub_data$Goals + ratio_offset)/
                            (sub_data$TotalGoals + ratio_offset),
                             digits=2)
  return(sub_data)
}

sub_data <- get_long_data()

#Take a peek.
head(sub_data[,-c(2:4)])
```

This long form data will be more useful in some instances. Now I can predict win/lose/draw for teams rather than say home/away/draw which would have been confounded by the fact that a given team can be either home or away. An importatn thing to note is there is now 2 rows per match. One row for the home team and one for the away team. Another benefit off this new structure is that I can now aggregate it. Summing the points for a given team easily.

# Data Exploration
## Best Teams
```{r message=FALSE, warning=FALSE}
# Take another subset
interestcols<-c("Season", "Date", "HomeOrAway", "Referee",
                "TeamName", "Opponent", "Points", "Goals",
                "TotalGoals", "GoalRatio")
formed_data <- sub_data[, interestcols]


## More exploration
numerical <- formed_data[,-c(1,2,3,4,5,6)]
sum_mat<-aggregate(numerical, by=list(formed_data$Season, 
                                      formed_data$TeamName), 
                   FUN=sum)
mean_mat<-aggregate(numerical, by=list(formed_data$Season, 
                                       formed_data$TeamName
                                       ), FUN=mean)
sum_mat$GoalRatio <- mean_mat$GoalRatio
sum_mat <- rename(sum_mat, c("Group.1"="Season",
                             "Group.2"="TeamName"))
sum_mat<-sum_mat[order(as.character(sum_mat$Season), sum_mat$Points, decreasing=TRUE),]
row.names(sum_mat)<-1:120
sum_mat<-ddply(sum_mat, .(Season), transform, Rank = rank(-Points, ties.method="first"))


p<- ggplot(sum_mat, aes(Season, Points, group=TeamName,
                        colour=TeamName))
p + geom_path(alpha=1)+ labs(title = "Team Points by Season"
                             ) + guides(colour=guide_legend
                                        (ncol=2))
```


Naively one would assume that the match result and teams playing would appear to be the most imortant factors. So a question to ask is which teams are the best historically and how are these different teams doing?


Of course we immeadiatly see multiple problems with this chart. One is that the 2015/16 season 
is incomplete so all the lines collapse to the center. Also maybe it is a better question to
ask what is the rank of any given team in a particular year.


```{r}
p <- ggplot(sum_mat, aes(Season, Rank, group=TeamName,
                        colour=TeamName))
p + geom_path(alpha=1)+ labs(title= "Team Rank by Season") +
  guides(colour=guide_legend(ncol=2))
  
# Look at trends over time
rank_by_season <- cast(sum_mat, TeamName ~Season, mean,   value='Rank')
rank_by_season

```

From this, improved chart we can see that team performance is quite volatile and unpredicatble. Teams can move up and down the leaderboard year to year.
We also see a lot of the teams at the top of the chart tend to be discontinuos as they get relegated due to poor performance. The table at the bottom makes this a little easier to see. The NaN values represent years in which that team did not participate.

Now that I have some idea of what teams are doing well my next exploratory questions are to look at if there are any other interesting relationships.

## Home and Away
```{r}
# How many points on average do you get for a home or away match?
tapply(sub_data$Points, sub_data$HomeOrAway, FUN=mean)


# Examine relationship between home and away results
win_odds<-prop.table(table(cleaned_data$FTR))
win_odds

round(win_odds/min(win_odds),2)

# There is a statistical difference between
t.test(cleaned_data$FTHG, cleaned_data$FTAG, paired=TRUE)

```
It seems my soccer loving friends were correct there seems to be a large difference between home and away performances in favour of home. Home victory is ~50% more likely than an away victory.

## Referees
```{r}
# Are there differences between referees?

tapply(cleaned_data$TotalGoals,cleaned_data$Referee, FUN=mean)

p <- ggplot(cleaned_data, aes(Referee, TotalGoals))
p + geom_boxplot() + geom_jitter() + labs(title= "Total 
                                          Goals by referee.")

```

There appears to be no relationship between total goals and referee


## Half time vs. Full time.
```{r}
# Relationship betwen half time result and full time result.
prop.table(table(cleaned_data$FTR, cleaned_data$HTR),2)

summary(lm(cleaned_data$FTHG~cleaned_data$FTAG))
p <- ggplot(cleaned_data, aes(FTAG, FTHG))
p + geom_point() + geom_smooth(method = "lm", se = FALSE)

tapply(cleaned_data$FTHG, cleaned_data$Season, FUN=mean)
tapply(cleaned_data$FTAG, cleaned_data$Season, FUN=mean)

```

## Match Statistics.
While the match statistics are very interesting I didn't explore them too much as they wouldn't be of huge use in predicting match results. However here are some of my observations.

```{r}
# Relationship between shots and goals
p <- ggplot(cleaned_data, aes(HS, FTHG))
p + geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Home Team Goals as a Function of Shots")
summary(lm(cleaned_data$FTHG~cleaned_data$HS ))

# Score drivers
# 2,3 are team names
match_stats<-cleaned_data[,colnames(cleaned_data)[c(2,3,4,5,11:22)]]
cor(match_stats[,-c(1,2)])
```

There are some pretty strong correlations in here which 

## Gambling Data.

```{r}
p <- ggplot(cleaned_data, aes(B365H, WHH))
p + geom_point() + geom_smooth(method = "lm", se = FALSE)

p <- ggplot(cleaned_data, aes(VCH, WHH))
p + geom_point() + geom_smooth(method = "lm", se = FALSE)
```
I found most of the bookies were in agreement when it came to the odds. These above plots show the very strong correlations. I expect that this data will be quite useful when it comes to trying to predict match results. Well, at least as useful as any.


# Data modelling.
For this section I 